<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.56">
<title data-react-helmet="true">Ansible-PlayBook | Lofty不造反</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Ansible-PlayBook | Lofty不造反"><meta data-react-helmet="true" name="description" content="Ansible-playbook"><meta data-react-helmet="true" property="og:description" content="Ansible-playbook"><meta data-react-helmet="true" property="og:url" content="https://haoxincheng.github.io/docs/ansible-apply2"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://haoxincheng.github.io/docs/ansible-apply2"><link rel="stylesheet" href="/styles.82555bd1.css">
<link rel="preload" href="/styles.1a9ec389.js" as="script">
<link rel="preload" href="/runtime~main.739a86b6.js" as="script">
<link rel="preload" href="/main.19b2f63f.js" as="script">
<link rel="preload" href="/1.35b9525b.js" as="script">
<link rel="preload" href="/2.d873ae70.js" as="script">
<link rel="preload" href="/3.a93fd31b.js" as="script">
<link rel="preload" href="/1be78505.5cf2f76b.js" as="script">
<link rel="preload" href="/105.8cd7c692.js" as="script">
<link rel="preload" href="/20ac7829.a545ebb3.js" as="script">
<link rel="preload" href="/e9e21b2a.896e4bb4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.jpg" alt="My Facebook Project Logo"><strong class="navbar__title">Lofty不造反</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/job">面试宝典</a><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.jpg" alt="My Facebook Project Logo"><strong class="navbar__title">Lofty不造反</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/job">面试宝典</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">OS操作系统</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Centos</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/centos-readme">安装Centos7</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/centos-prod">Centos7生产建议</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/centos-cmd1">Centos7常用命令</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/centos-cmd2">文件和目录操作命令</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Ubuntu</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ubuntu-readme">安装与使用Ubuntu</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ubuntu-cmd1">Ubuntu常用命令</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Shell编程</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/shell-readme">Shell介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Web应用</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Nginx</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/nginx-readme">Nginx介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/nginx-install">安装Nginx</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/nginx-seo">Nginx优化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/nginx-faq">Nginx常见问题</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Apache</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/apache-readme">Apache介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Tomcat</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tomcat-readme">TomCat介绍</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">SQL数据库</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">MySQL</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/mysql-readme">MySQL介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/mysql-install">安装MySQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/mysql-seo">MySQL优化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/mysql-faq">MySQL常见问题</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Oarcle</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/oracle-readme">Oracle介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">SQLServer</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/sqlserver-readme">sqlserver-readme</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">NOSQL数据库</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Redis</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/redis-readme">redis-readme</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Memcache</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/memcache-readme">Memcache介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">MongoDB</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/mongodb-readme">MongoDB介绍</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Storage存储</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">nfs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/nfs-readme">NFS介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">gfs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/gfs-readme">GFS介绍</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Network网络</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">OpenVPN</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/openvpn-readme">openvpn-readme</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Monitor监控</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Zabbix</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zabbix-readme">Zabbix介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zabbix-install">zabbix-install</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zabbix-seo">Zabbix优化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zabbix-faq">Zabbix常见问题</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">DevOps自动化</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">PXE</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/pxe-readme">PXE介绍</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Jenkins</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/jenkins-readme">Jenkins介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/jenkins-install">Jenkins安装</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/jenkins-seo">Jenkins优化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/jenkins-faq">Jenkins常见问题</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Ansible</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ansible-readme">Ansible介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ansible-install">Ansible安装</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ansible-apply1">Ansible模块使用</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/ansible-apply2">Ansible-PlayBook</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ansible-config">Ansible配置详解</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ansible-seo">Ansible优化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ansible-faq">Ansible常见问题</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">SaltStack</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/saltstack-readme">安装Saltstack</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/saltstack-install">安装SaltStack</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Puppet</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/puppet-readme">MySQL介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/puppet-install">安装Puppet</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Cloud云计算</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Docker</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/docker-install">安装Docker</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/docker-cmd">Docker常用命令</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">OpenStack</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/openstack-readme">openstack-readme</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/openstack-install">安装OpenStack</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/kubernetes-readme">Kubernetes介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/kubernetes-install">Kubernetes安装</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">运维心得</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/devops1">运维心得 v1.0</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/devops2">运维心得 v2.0</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Ansible-PlayBook</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="ansible-playbook"></a>Ansible-playbook<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ansible-playbook" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="什么是playbook？"></a>什么是playbook？<a aria-hidden="true" tabindex="-1" class="hash-link" href="#什么是playbook？" title="Direct link to heading">#</a></h3><ul><li><p>playbook 是由一个或多个play组成的列表 </p></li><li><p>playbook采用YAML语言编写</p></li></ul><p>说白了就是一个脚本，也可以说是一个编排工具。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="yaml语法说明"></a>YAML语法说明<a aria-hidden="true" tabindex="-1" class="hash-link" href="#yaml语法说明" title="Direct link to heading">#</a></h3><ol><li>以 --- (三个减号)开始，必须顶行写</li><li>次行开始写Playbook的内容，但是一般要求写明该playbook的功能</li><li>严格缩进，并且不能用Tab键缩进；</li><li>缩进级别必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的；</li><li>K/V的值可同行写，也可换行写。同行使用 :分隔，换行写需要以 - 分隔；</li></ol><p>实例脚本</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web    # 将要执行任务的主机，已经在hosts文件中定义好了，可是单个主机或主机组</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root      # 在目标主机上执行任务时的用户身份</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vars:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - pkg: httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: &quot;install httpd package.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name={{ pkg }}  state=installed</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: &quot;copy httpd configure file to remote host.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      copy: src=/root/conf/httpd.conf dest=/etc/httpd/conf/httpd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      notify: restart httpd     # 当这个任务执行状态发生改变时，触发handlers执行.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: &quot;boot httpd service.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=started</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  handlers:      # handlers与tasks是同一级别</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: restart httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=restarted</span></div></div></div></div></div><p> 其工作流程图如下：</p><p> <img src="/uploads/projects/ansible_lofty/df0adb7ff53b29c02381a8c1d95193b1.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="playbook的核心组成"></a>playbook的核心组成<a aria-hidden="true" tabindex="-1" class="hash-link" href="#playbook的核心组成" title="Direct link to heading">#</a></h3><p>-  Hosts 执行的远程主机列表</p><p>-  Tasks 任务集</p><p>-  Varniables 内置变量或自定义变量在playbook中调用</p><p>-  Templates 模板，可替换模板中的变量并实现一些简单的逻辑的文件  </p><p>-  Hanglers和notify结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</p><p>-  Tags 标签 制定某条任务执行，用户选择运行playbook中的部分代码，ansible具有幂等性，因此会自动跳过没有辩护的部分，即便如此，有的代码为测试其确实没有发生变化的时间依然会非常的长，此时确信其没有变化，就可以通过tags跳过这些代码片段</p><p><code>ansible-playbook -t tagsname useradd.yml</code></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="第一个helloyml"></a>第一个hello.yml<a aria-hidden="true" tabindex="-1" class="hash-link" href="#第一个helloyml" title="Direct link to heading">#</a></h2><p>新创建一个hello.yml文件</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat /etc/ansible/scripts/hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web  #指定执行剧本的主机列表</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root  #指定以什么用户去执行playbook</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:  #任务列表</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new file  #任务名称</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data state=directory  #任务模块</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      user: name=lilei shell=/sbin/nologin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: install httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name=httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: start service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=started enabled=yes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>运行hello.yml</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C hello.yml  #检测playbook语法，检测的时不会对系统做出任何更改。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook hello.yml  #执行playbook</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>脚本参数说明：</p><ul><li><p><code>Hosts</code>：playbook中的每一个play 的目的都是为了让某个或某些主机以某个特定身份执行任务，hosts用于制定要执行执行任务的主机，须事先定义在主机清单内。可以是两个组的并集，也可以是两个组的交集，也支持模糊匹配。 </p></li><li><p><code>remote_user</code>：可用于Host和task中，也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某服务；次在，甚至可以在sudo时使用sudo_user制定sudo时切换的用户 </p></li><li><p><code>tasks</code>：play的主题部分是task list。task list中的个任务按次序诸葛在hosts制定的所有主机下执行，即在所有主机上完成第一个任务后开始第二个。</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="ansible-playbook命令语法"></a>ansible-playbook命令语法<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ansible-playbook命令语法" title="Direct link to heading">#</a></h2><p>运行playbook的方式</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ansible-playbook filename.yml ...[options]</span></div></div></div></div></div><p>常见选项</p><ul><li><p><code>-- check</code>只检测可能发生的改变，不真正执行等于-C</p></li><li><p><code>--list-hosts</code> 列出运行任务的主机</p></li><li><p><code>--limit</code> 主机列表指着对主机列表中的主机执行</p></li><li><p><code>-v</code> 显示过程 </p></li><li><p><code>-vv</code> <code>-vvv</code> 更详细</p></li></ul><p>实例</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ansible-playbook -C file.yml #只检测语法和可能发生的改变，不会真正的改变</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ansible-playbook file.yml #运行脚本</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ansible-playbook file.yml --limit web #指定运行的组、主机</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#例如：所有主机都安装成功了，但是web组存在问题，又不想修改yml的内容，所以可以指定运行的主机</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ansible-playbook file.yml --list-tasks #列出要运行的主机</span></div></div></div></div></div><p>当我们对服务的配置文件更改时，如果还是用以上的方法，服务是不会根据配置文件的修改后进行自动重启而生效的，如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data state=directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      user: name=lilei shell=/sbin/nologin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: install httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name=httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: copy conf file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      copy: src=conf_files/httpd.conf dest=/etc/httpd/conf/httpd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: start service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=started enabled=yes</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="playbook的handlers、notify触发"></a>playbook的handlers、notify触发<a aria-hidden="true" tabindex="-1" class="hash-link" href="#playbook的handlers、notify触发" title="Direct link to heading">#</a></h2><p>notify触发之后，handlers语句才能执行</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#创建文件  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data state=directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#创建用户</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      user: name=lilei shell=/sbin/nologin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#安装httpd服务</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: install httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name=httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#拷贝配置文件</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: copy conf file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      copy: src=conf_files/httpd.conf dest=/etc/httpd/conf/httpd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      notify: restart service    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">|  #notify主要用于检测文件的变化，而通知handler对应的模块</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#启动服务</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: start service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=started enabled=yes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#如果配置文件发生变化则会调用handlers下面的模块</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  handlers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: restart service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=restarted</span></div></div></div></div></div><p>httpd.conf 将配置文件改一下端口
查看是否生效，看看是否把80端口改成了82</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a netstat -tulnp |grep 82</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="playbook的标签"></a>playbook的标签<a aria-hidden="true" tabindex="-1" class="hash-link" href="#playbook的标签" title="Direct link to heading">#</a></h2><ul><li>标签（tags）在众多的playbook当中，我们为了更加方便地调用公共模块的tasks，通常会给一些tasks进行打定标签，在执行的过程中进行指定标签运行，以实现我们的目标需求，如下：</li></ul><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data state=directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      user: name=lilei shell=/sbin/nologin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: install httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name=httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: install_httpd  #安装httpd的标签</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: copy conf file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      copy: src=conf_files/httpd.conf dest=/etc/httpd/conf/httpd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      notify: restart service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: restart_httpd  #重启httpd服务的标签</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: start service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=started enabled=yes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: start_httpd  #启动httpd的标签</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  handlers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: restart service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=restarted</span></div></div></div></div></div><p>直接调用了重启httpd服务的标签，-t为指定标签执行，也可以指定多个标签一起执行</p><p>一个name对应一个tag，也就是你运行<code>hhh</code>，其实是<code>name: install httpd</code></p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data1 state=directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      user: name=lilei1 shell=/sbin/nologin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: install httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name=httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: hhh  #安装httpd的标签</span></div></div></div></div></div><p>指定tag</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -t restart_httpd hello.yml</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="playbook变量"></a>PlayBook变量<a aria-hidden="true" tabindex="-1" class="hash-link" href="#playbook变量" title="Direct link to heading">#</a></h2><ul><li>变量（vars)在playbook当中，所有的任务都是固定的模式，在针对主机时，也是固定组别，服务端口等等也是固定的，写过shell脚本的大佬都知道在一个脚本当中，对于常用的量以变量代替，从而增加脚本的灵活性，那么在playbook当中也是可以引入变量的。</li></ul><p>变量名的组成：只能由字母、数字和下划线组成，且只能字母开头</p><p><strong>变量的定义方式：</strong></p><ul><li>ansible setup facts远程主机所有的变量可直接调用，支持通配符。</li></ul><p>下面可以通过<code>setup</code>模块过滤出ip的变量名为：<code>ansible_all_ipv4_addresses</code>，那么在使用时，可以直接调用该变量名，以实现调用。</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ~]# ansible web -m setup -a filter=*address*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | SUCCESS = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ansible_facts: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ansible_all_ipv4_addresses: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            192.168.0.116</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ansible_all_ipv6_addresses: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            fe80::20c:29ff:fef3:ce94</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    changed: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | SUCCESS = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ansible_facts: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ansible_all_ipv4_addresses: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            192.168.0.135</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ansible_all_ipv6_addresses: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            fe80::20c:29ff:fe4c:ef31</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    changed: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>在/etc/ansible/hosts中进行定义，普通变量（主机组中主机单独定义，优先级高于公共变量），公共变量（是在主机组中对所有主机定义的统一变量）</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat vars.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: set hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      hostname: name={{ nodename }}.{{ domainname }}  #playbook中的变量调用</span></div></div></div></div></div><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim /etc/ansible/hosts </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[web]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 nodename=node01  #普通变量的定义</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 nodename=node02</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[web:vars]  #新增变量组，公共变量的定义</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">domainname=magedu.com</span></div></div></div></div></div><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C vars.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook vars.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | CHANGED | rc=0 ;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node01.magedu.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 ;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node02.magedu.com</span></div></div></div></div></div><p>命令行指定变量，优先级是最高的。在命令行用-e参数指定变量的值</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -e domainname=baidu.com vars.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node02.baidu.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node01.baidu.com</span></div></div></div></div></div><p>playbook中定义变量</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">vars:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- var1: value1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- var2: value2</span></div></div></div></div></div><p>修改playbook，增加变量使用</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim vars.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  #配置domainname变量</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vars:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - domainname: magedu.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: set hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      hostname: name={{ nodename }}.{{ domainname }}</span></div></div></div></div></div><p>检测语法后执行，并查看执行后效果</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C vars.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook vars.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node01.magedu.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node02.magedu.com</span></div></div></div></div></div><p><strong>5. 独立的YAML文件中定义</strong></p><p>对于变量管理，由于变量有多重方式可以定义，不同人习惯会导致变量混乱等，故可以考虑吧变量放在同一文件内，使用的时候在文件内修改，剧本中调用该文件。</p><p> 新建var.yml增加变量定义</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim var.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">domainname: hao123.com</span></div></div></div></div></div><p>在playbook进行调用变量定义文件</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim vars.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  #导入变量文件，这里使用的相对路径，必须和playbook在同一目录下，如果不在同一目录，则需要写全路径</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vars_files:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - var.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: set hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      hostname: name={{ nodename }}.{{ domainname }}</span></div></div></div></div></div><p>使用</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C vars.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook  vars.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a hostname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node01.hao123.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node02.hao123.com</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="playbook的模板"></a>Playbook的模板<a aria-hidden="true" tabindex="-1" class="hash-link" href="#playbook的模板" title="Direct link to heading">#</a></h2><p>在生产服务器集群当中，每台服务器的配置都可能存在不同，在使用ansible进行自动化运维时</p><p>只是单纯的查询式操作，我们可以使用普通命令行<code>ansible &lt;hosts&gt;  -m &lt;module&gt;  -a &quot;xxx&quot;</code>的模式进行进行批量查询，如查询负载，内存，cpu资源使用率等指标数据。</p><p>而当我们需要批量化对目标主机进行批量任务操作时，如安装服务，启动服务，设置开机自启等批量化任务时，我们采用了playbook的方式进行任务的批量化执行。而在针对配置更改，实现服务自动重启，也采用了handlers+notify的方式进一步实现自动化的批量更改生效。</p><p>与此同时，在使用ansible批量化自动运维时，还增加了变量和标签，以提高playbook的灵活性，以上的种种都说明了ansible模块化的强大功能。</p><p>而对于不同服务器的配置，以及不同的使用需求时，又改如何去更加灵活地去编写playbook来提高实用性呢？而ansible就提供了这样的一种模板（template）模块。假设有这样的一个需求，进行批量化部署httpd服务后，要求监听的服务端口分别为87、88端口。那么可以来一场这样的剧演：
（1）创建模板配置目录，拷贝httpd服务的配置文件为j2后缀文件</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# mkdir templates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cp conf_files/httpd.conf templates/httpd.conf.j2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cd templates/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible templates]# ll</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">total 12</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root 12026 Nov 19 13:51 httpd.conf.j2</span></div></div></div></div></div><p>（2）修改j2文件的配置，更改监听端口配置为http_port变量调用</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible templates]# vim httpd.conf.j2 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Listen {{ http_port }}</span></div></div></div></div></div><p>（3）修改主机列表中的普通变量，增加每台主机分别监听的端口变量</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible templates]# vim /etc/ansible/hosts </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[web]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 nodename=node01 http_port=87</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 nodename=node02 http_port=88</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[web:vars]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">domainname=magedu.com</span></div></div></div></div></div><p>（4）编写playbook</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data state=directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create new user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      user: name=lilei shell=/sbin/nologin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: install httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name=httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: install_httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: copy conf template file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#这里要使用的是template模块，使用方式和copy模块类似</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      template: src=templates/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      notify: restart service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: restart_httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: start service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=started enabled=yes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: start_httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  handlers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: restart service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=restarted</span></div></div></div></div></div><p>（5）playbook测试与执行和查看执行结果</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C hello.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a netstat -tulnp |grep httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tcp6       0      0 :::87                   :::*                    LISTEN      32274/httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tcp6       0      0 :::88                   :::*                    LISTEN      28307/httpd         </span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="playbook的条件语句--when"></a>playbook的条件语句--When<a aria-hidden="true" tabindex="-1" class="hash-link" href="#playbook的条件语句--when" title="Direct link to heading">#</a></h2><p>有时候我们希望对某些特定的主机执行某些特定的操作，比如对指定的系统版本，进行关机操作，如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: shut down Debian flavored systems</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    command: /sbin/shutdown -t now</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    when: ansible_facts[os_family] == Debian</span></div></div></div></div></div><p>也可以进行分组多个条件组合进行判断</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: shut down CentOS 6 and Debian 7 systems</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    command: /sbin/shutdown -t now</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    when: (ansible_facts[distribution] == CentOS and ansible_facts[distribution_major_version] == 6) or</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          (ansible_facts[distribution] == Debian and ansible_facts[distribution_major_version] == 7)</span></div></div></div></div></div><p>当需要多个条件都必须具备时，可以使用列表的方式进行指定</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: shut down CentOS 6 systems</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    command: /sbin/shutdown -t now</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    when:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - ansible_facts[distribution] == CentOS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - ansible_facts[distribution_major_version] == 6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/code&gt;&lt;/pre&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">使用举例：对判断被控端的主机名为node02.hao123.com的主机进行更改httpd服务的端口</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;pre&gt;# 使用setup获取目标主机的公共变量值</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m setup -a filter=*hostname*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | SUCCESS = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ansible_facts: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ansible_hostname: node01</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    changed: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | SUCCESS = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ansible_facts: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ansible_hostname: node02</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    changed: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 编写playbook</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vars:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - http_port: 90</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: install httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      yum: name=httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: install_httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: copy conf template file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      template: src=templates/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      when: ansible_hostname == node02  #增加判断条件，当 hostname为node02才会更改配置文件，并重启服务</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      notify: restart service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: restart_httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: start service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=started enabled=yes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      tags: start_httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  handlers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: restart service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      service: name=httpd state=restarted</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook hello.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible 192.168.0.116 -m shell -a netstat -tulnp |grep httpd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tcp6       0      0 :::90                   :::*                    LISTEN      30308/httpd         </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/code&gt;&lt;/pre&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">### 1.7、playbook的循环迭代--Item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Item主要用于循环迭代多个重复的操作，比如批量创建用户、批量创建文件等等。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;pre&gt;# 编写playbook，进行批量创建文件</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat item.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data state=directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: create files</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: name=/data/{{ item }} state=touch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      when: ansible_hostname == node02</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      with_items:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - file1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - file2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - file3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C item.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook item.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible 192.168.0.116 -m shell -a ls -l /data/file*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root 0 Nov 19 15:34 /data/file1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root 0 Nov 19 15:34 /data/file2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root 0 Nov 19 15:34 /data/file3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 创建3个组，3个用户，并且对应每一个组</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat item_user_group.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: add some groups</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      group: name={{ item }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      with_items:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - g1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - g2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - g3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: add some users</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      user: name={{ item.name }} group={{ item.group }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      with_items:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - { name: user1 , group: g1}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - { name: user2 , group: g2}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - { name: user3 , group: g3}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C item_user_group.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook item_user_group.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/code&gt;&lt;/pre&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">### 1.8、playbook的循环语句--For</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">重复性执行一段代码，生成一段配置信息。示例如下：</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;pre&gt;# for循环使用语法示例：</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% for vhost in nginx/-vhosts %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">listen {{ vhost.listen| default(80 default_server) }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% endfor %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 通过jin2模板生成不同监听端口的server标签</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat for.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vars:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - 83</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - 84</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: copy conf file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      template: src=templates/nginx.conf.j2 dest=/data/nginx.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 模板中通过定义循环，生成配置</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# cat templates/nginx.conf.j2 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% for port in ports %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     listen {{ port }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% endfor %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook for.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a cat /data/nginx.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     listen 83</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     listen 84</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     listen 83</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     listen 84</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/code&gt;&lt;/pre&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">### 1.9、playbook的判断语句--If</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">通过判断去执行，和shell的语法类似：</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;pre&gt;{% if vhost.server_name is defined %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server_name {{vhost.server_name }};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% if vhost.root is defined 80 %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">root {{ vhost.root }};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 创建3个不同的web站点</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim testif1.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vars:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - web1:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        port: 86</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        #name: web1.hao123.com   #注释</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rootdir: /data/website1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - web2:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        port: 87</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        name: web2.hao123.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rootdir: /data/website2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - web3:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        port: 88</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        #name: web3.hao123.com   #注释</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        rootdir: /data/website3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: copy conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      template: src=for3.conf.j2 dest=/data/for3.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#对p.name进行判断，没有则不生成servername</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# vim templates/for3.conf.j2 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#只有87端口的server有servername  别的由于被注释，if判断不存在 就不创建servername</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% for p in ports %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        listen {{ p.port }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% if p.name is defined %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        servername {{ p.name }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% endif %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        documentroot {{ p.rootdir }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{% endfor %}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook testif1.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a less /data/for3.conf</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/code&gt;&lt;/pre&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">### 1.10、playbook的异常处理</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">默认Playbook会检查命令和模块的返回状态，如遇到错误就中断playbook的执行加入参数: ignore_errors: yes 忽略错误</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;pre&gt;[root@ansible ansible]# vim ignore.yml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- hosts: web</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  remote_user: root</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tasks:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: Ignore False</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      command: /bin/false  #直接执行返回false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      ignore_errors: yes  #忽略错误</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 当上一个任务遇到错误中断时，后面的任务就不会执行了</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - name: touch files</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      file: path=/tmp/bgx_ignore state=touch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook -C ignore.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible-playbook ignore.yml </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[root@ansible ansible]# ansible web -m shell -a ls -l /tmp/bgx_ignore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.116 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root 0 Nov 20 14:35 /tmp/bgx_ignore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">192.168.0.135 | CHANGED | rc=0 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1 root root 0 Nov 20 14:35 /tmp/bgx_ignore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/code&gt;&lt;/pre&gt;-</span></div></div></div></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/ansible-apply2.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/ansible-apply1"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Ansible模块使用</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/ansible-config"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ansible配置详解 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ansible-playbook" class="table-of-contents__link">Ansible-playbook</a><ul><li><a href="#什么是playbook？" class="table-of-contents__link">什么是playbook？</a></li><li><a href="#yaml语法说明" class="table-of-contents__link">YAML语法说明</a></li><li><a href="#playbook的核心组成" class="table-of-contents__link">playbook的核心组成</a></li></ul></li><li><a href="#第一个helloyml" class="table-of-contents__link">第一个hello.yml</a></li><li><a href="#ansible-playbook命令语法" class="table-of-contents__link">ansible-playbook命令语法</a></li><li><a href="#playbook的handlers、notify触发" class="table-of-contents__link">playbook的handlers、notify触发</a></li><li><a href="#playbook的标签" class="table-of-contents__link">playbook的标签</a></li><li><a href="#playbook变量" class="table-of-contents__link">PlayBook变量</a></li><li><a href="#playbook的模板" class="table-of-contents__link">Playbook的模板</a></li><li><a href="#playbook的条件语句--when" class="table-of-contents__link">playbook的条件语句--When</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/centos-readme">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1Wg7"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright © 2020 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.1a9ec389.js"></script>
<script src="/runtime~main.739a86b6.js"></script>
<script src="/main.19b2f63f.js"></script>
<script src="/1.35b9525b.js"></script>
<script src="/2.d873ae70.js"></script>
<script src="/3.a93fd31b.js"></script>
<script src="/1be78505.5cf2f76b.js"></script>
<script src="/105.8cd7c692.js"></script>
<script src="/20ac7829.a545ebb3.js"></script>
<script src="/e9e21b2a.896e4bb4.js"></script>
</body>
</html>